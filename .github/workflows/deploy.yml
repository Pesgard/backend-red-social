name: üöÄ Deploy to Production (Dokploy)

on:
  push:
    branches:
      - master

env:
  IMAGE_NAME: backend_red_social_gera
  PROJECT_NAME: redsocialgera
  ENVIRONMENT_NAME: production
  APP_NAME: redsocialgera-backend
  MONGO_APP_NAME: redsocialgera-mongodb
  DOKPLOY_URL: ${{ secrets.DOKPLOY_URL }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Docker Setup
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKHUB_USERNAME }}
          password: ${{ secrets.DOCKHUB_PASSWORD }}

      # 3Ô∏è‚É£ Build and push image
      - name: Build and Push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest
            ${{ secrets.DOCKHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          platforms: linux/amd64,linux/arm64
          cache-from: type=registry,ref=${{ secrets.DOCKHUB_USERNAME }}/${{ env.IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ secrets.DOCKHUB_USERNAME }}/${{ env.IMAGE_NAME }}:buildcache,mode=max

      - name: üîç Check or Create Project in Dokploy
        id: setup_project
        run: |
          echo "üîç Checking if project exists..."
          PROJECT_RESPONSE=$(curl -s -H "x-api-key: ${{ secrets.DOKPLOY_API_KEY }}" "$DOKPLOY_URL/project.all")
      
          # Muestra la respuesta para debug
          echo "Project response: $PROJECT_RESPONSE"
      
          # Buscar el proyecto por nombre
          PROJECT_ID=$(echo "$PROJECT_RESPONSE" | jq -r "map(select(.name==\"${{ env.PROJECT_NAME }}\"))[0].projectId")
      
          if [ "$PROJECT_ID" == "null" ] || [ -z "$PROJECT_ID" ]; then
            echo "üß© Creating project ${{ env.PROJECT_NAME }}..."
            CREATE_RESPONSE=$(curl -s -X POST "$DOKPLOY_URL/project.create" \
              -H "x-api-key: ${{ secrets.DOKPLOY_API_KEY }}" \
              -H "Content-Type: application/json" \
              -d "{\"name\": \"${{ env.PROJECT_NAME }}\", \"description\": \"Proyecto CI/CD autom√°tico\", \"env\": \"production\"}")
            
            echo "Create response: $CREATE_RESPONSE"
            
            # Extraer el projectId y environmentId del JSON real
            PROJECT_ID=$(echo "$CREATE_RESPONSE" | jq -r ".project.projectId")
            ENV_ID=$(echo "$CREATE_RESPONSE" | jq -r ".environment.environmentId")
          else
            echo "‚úÖ Project already exists, getting environment..."
            ENV_RESPONSE=$(curl -s -H "x-api-key: ${{ secrets.DOKPLOY_API_KEY }}" "$DOKPLOY_URL/environment.byProjectId?projectId=$PROJECT_ID")
            echo "Env response: $ENV_RESPONSE"
            ENV_ID=$(echo "$ENV_RESPONSE" | jq -r "map(select(.name==\"${{ env.ENVIRONMENT_NAME }}\"))[0].environmentId")
      
            if [ "$ENV_ID" == "null" ] || [ -z "$ENV_ID" ]; then
              echo "üß© Creating environment ${{ env.ENVIRONMENT_NAME }}..."
              CREATE_ENV=$(curl -s -X POST "$DOKPLOY_URL/environment.create" \
                -H "x-api-key: ${{ secrets.DOKPLOY_API_KEY }}" \
                -H "Content-Type: application/json" \
                -d "{\"name\": \"${{ env.ENVIRONMENT_NAME }}\", \"description\": \"Entorno de producci√≥n\", \"projectId\": \"$PROJECT_ID\"}")
              ENV_ID=$(echo "$CREATE_ENV" | jq -r ".environmentId")
            fi
          fi
      
          echo "‚úÖ Project ID: $PROJECT_ID"
          echo "‚úÖ Environment ID: $ENV_ID"
      
          echo "project_id=$PROJECT_ID" >> $GITHUB_OUTPUT
          echo "env_id=$ENV_ID" >> $GITHUB_OUTPUT
        
      # 6Ô∏è‚É£ Create Mongo service (if not exists)
      - name: üçÉ Create MongoDB in Dokploy
        id: create_mongo
        run: |
          ENV_ID=${{ steps.setup_project.outputs.env_id }}
          echo "üîç Checking if MongoDB exists in environment $ENV_ID ..."
          
          # Consultar todos los MongoDB existentes
          MONGO_RESPONSE=$(curl -s -H "x-api-key: ${{ secrets.DOKPLOY_API_KEY }}" "$DOKPLOY_URL/mongo.all")
          echo "Mongo.all response: $MONGO_RESPONSE"

          # Filtrar por nombre (si la respuesta es un array)
          if echo "$MONGO_RESPONSE" | jq -e . >/dev/null 2>&1; then
            MONGO_ID=$(echo "$MONGO_RESPONSE" | jq -r "map(select(.name==\"${{ env.MONGO_APP_NAME }}\"))[0].mongoId // empty")
          else
            MONGO_ID=""
          fi

          if [ -z "$MONGO_ID" ]; then
            echo "üß© Creating MongoDB service..."
            CREATE_MONGO=$(curl -s -X POST "$DOKPLOY_URL/mongo.create" \
              -H "x-api-key: ${{ secrets.DOKPLOY_API_KEY }}" \
              -H "Content-Type: application/json" \
              -d "{
                \"name\": \"${{ env.MONGO_APP_NAME }}\",
                \"appName\": \"${{ env.MONGO_APP_NAME }}\",
                \"dockerImage\": \"mongo:7.0-jammy\",
                \"environmentId\": \"$ENV_ID\",
                \"description\": \"MongoDB for backend\",
                \"databaseUser\": \"admin\",
                \"databasePassword\": \"change_me_in_dokploy\",
                \"replicaSets\": false
              }")

            echo "Mongo.create response: $CREATE_MONGO"

            # Si devuelve solo "true", no hay ID disponible, pero al menos confirmamos que se cre√≥
            if [ "$CREATE_MONGO" = "true" ]; then
              echo "‚úÖ MongoDB service created successfully (no ID returned)."
            else
              MONGO_ID=$(echo "$CREATE_MONGO" | jq -r ".mongoId // empty")
            fi
          else
            echo "‚úÖ MongoDB already exists."
          fi

          echo "‚úÖ MongoDB ID: ${MONGO_ID:-unknown}"
          echo "mongo_id=${MONGO_ID:-unknown}" >> $GITHUB_OUTPUT

      # 7Ô∏è‚É£ Create Backend application (if not exists)
      - name: üöÄ Create Backend in Dokploy
        id: create_backend
        run: |
          ENV_ID=${{ steps.setup_project.outputs.env_id }}
          echo "üîç Checking if backend exists..."

          # Igual que antes, no existe /application.one?appName
          APP_RESPONSE=$(curl -s -H "x-api-key: ${{ secrets.DOKPLOY_API_KEY }}" "$DOKPLOY_URL/application.all")
          APP_ID=$(echo "$APP_RESPONSE" | jq -r "map(select(.name==\"${{ env.APP_NAME }}\"))[0].applicationId")

          if [ "$APP_ID" == "null" ] || [ -z "$APP_ID" ]; then
            echo "üß© Creating backend service..."
            CREATE_APP=$(curl -s -X POST "$DOKPLOY_URL/application.create" \
              -H "x-api-key: ${{ secrets.DOKPLOY_API_KEY }}" \
              -H "Content-Type: application/json" \
              -d "{
                \"name\": \"${{ env.APP_NAME }}\",
                \"appName\": \"${{ env.APP_NAME }}\",
                \"environmentId\": \"$ENV_ID\",
                \"description\": \"Backend NestJS API\",
                \"serverId\": null
              }")
            APP_ID=$(echo "$CREATE_APP" | jq -r ".applicationId")
          else
            echo "‚úÖ Backend already exists."
          fi

          echo "‚úÖ Backend ID: $APP_ID"
          echo "app_id=$APP_ID" >> $GITHUB_OUTPUT
        env:
          DOKPLOY_URL: ${{ secrets.DOKPLOY_URL }}
     
          # 8Ô∏è‚É£ Deploy Backend
      - name: Trigger Dokploy Deployment
        run: |
          APP_ID=${{ steps.create_backend.outputs.app_id }}
          echo "üöÄ Deploying backend in Dokploy..."
          curl -s -X POST "$DOKPLOY_URL/application.deploy" \
            -H "x-api-key: ${{ secrets.DOKPLOY_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{\"applicationId\": \"$APP_ID\", \"title\": \"Automatic Deploy\", \"description\": \"CI/CD auto deploy\"}"
          echo "‚úÖ Deployment triggered successfully"
