name: ğŸš€ Deploy to Production (Dokploy)

on:
  push:
    branches:
      - master

env:
  IMAGE_NAME: backend_red_social_gera
  PROJECT_NAME: redsocialgera
  ENVIRONMENT_NAME: production
  APP_NAME: redsocialgera-backend
  MONGO_APP_NAME: redsocialgera-mongodb
  DOKPLOY_URL: ${{ secrets.DOKPLOY_URL }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Checkout
      - name: ğŸ“¦ Checkout repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Docker Setup
      - name: ğŸ³ Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ”‘ Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKHUB_USERNAME }}
          password: ${{ secrets.DOCKHUB_PASSWORD }}

      # 3ï¸âƒ£ Build and push image
      - name: ğŸ—ï¸ Build and Push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest
            ${{ secrets.DOCKHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          platforms: linux/amd64,linux/arm64
          cache-from: type=registry,ref=${{ secrets.DOCKHUB_USERNAME }}/${{ env.IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ secrets.DOCKHUB_USERNAME }}/${{ env.IMAGE_NAME }}:buildcache,mode=max

      # 4ï¸âƒ£ Setup Project & Environment
      - name: ğŸ” Setup Project and Environment in Dokploy
        id: setup_project
        run: |
          echo "ğŸ” Checking if project exists..."
          PROJECT_RESPONSE=$(curl -s -H "x-api-key: ${{ secrets.DOKPLOY_API_KEY }}" "$DOKPLOY_URL/project.all")
          
          echo "API Response: $PROJECT_RESPONSE"
          
          # Buscar el proyecto por nombre (la API devuelve un array directo)
          PROJECT_ID=$(echo "$PROJECT_RESPONSE" | jq -r "map(select(.name==\"${{ env.PROJECT_NAME }}\"))[0].projectId // empty")
          
          if [ -z "$PROJECT_ID" ]; then
            echo "ğŸ§© Creating project ${{ env.PROJECT_NAME }}..."
            CREATE_RESPONSE=$(curl -s -X POST "$DOKPLOY_URL/project.create" \
              -H "x-api-key: ${{ secrets.DOKPLOY_API_KEY }}" \
              -H "Content-Type: application/json" \
              -d "{\"name\": \"${{ env.PROJECT_NAME }}\", \"description\": \"Red Social Gera - ProducciÃ³n\"}")
            
            echo "Create Response: $CREATE_RESPONSE"
            
            PROJECT_ID=$(echo "$CREATE_RESPONSE" | jq -r ".project.projectId")
            ENV_ID=$(echo "$CREATE_RESPONSE" | jq -r ".environment.environmentId")
            echo "âœ… Project created: $PROJECT_ID"
            echo "âœ… Environment created: $ENV_ID"
          else
            echo "âœ… Project already exists: $PROJECT_ID"
            
            # Obtener environment
            ENV_RESPONSE=$(curl -s -H "x-api-key: ${{ secrets.DOKPLOY_API_KEY }}" "$DOKPLOY_URL/project.one?projectId=$PROJECT_ID")
            ENV_ID=$(echo "$ENV_RESPONSE" | jq -r ".environments | map(select(.name==\"${{ env.ENVIRONMENT_NAME }}\"))[0].environmentId // empty")
            
            if [ -z "$ENV_ID"]; then
              echo "ğŸ§© Creating environment ${{ env.ENVIRONMENT_NAME }}..."
              CREATE_ENV=$(curl -s -X POST "$DOKPLOY_URL/environment.create" \
                -H "x-api-key: ${{ secrets.DOKPLOY_API_KEY }}" \
                -H "Content-Type: application/json" \
                -d "{\"name\": \"${{ env.ENVIRONMENT_NAME }}\", \"description\": \"Entorno de producciÃ³n\", \"projectId\": \"$PROJECT_ID\"}")
              ENV_ID=$(echo "$CREATE_ENV" | jq -r ".environmentId")
              echo "âœ… Environment created: $ENV_ID"
            else
              echo "âœ… Environment already exists: $ENV_ID"
            fi
          fi
          
          echo "âœ… Project ID: $PROJECT_ID"
          echo "âœ… Environment ID: $ENV_ID"
          
          echo "project_id=$PROJECT_ID" >> $GITHUB_OUTPUT
          echo "env_id=$ENV_ID" >> $GITHUB_OUTPUT

      # 5ï¸âƒ£ Update Project Environment Variables
      - name: ğŸ”§ Update Project Environment Variables
        run: |
          PROJECT_ID=${{ steps.setup_project.outputs.project_id }}
          
          echo "ğŸ”§ Updating project environment variables..."
          
          # Preparar variables de entorno para el proyecto
          ENV_VARS="NODE_ENV=production
          PORT=3000
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          JWT_EXPIRES_IN=7d
          CORS_ORIGIN=${{ secrets.CORS_ORIGIN }}
          MAX_FILE_SIZE=5242880
          UPLOAD_PATH=./uploads
          RATE_LIMIT_TTL=60
          RATE_LIMIT_MAX=100"
          
          curl -s -X POST "$DOKPLOY_URL/project.update" \
            -H "x-api-key: ${{ secrets.DOKPLOY_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{\"projectId\": \"$PROJECT_ID\", \"env\": $(echo "$ENV_VARS" | jq -Rs .)}"
          
          echo "âœ… Project environment variables updated"

      # 6ï¸âƒ£ Setup or Update MongoDB
      - name: ğŸƒ Setup MongoDB Service
        id: setup_mongo
        run: |
          ENV_ID=${{ steps.setup_project.outputs.env_id }}
          PROJECT_ID=${{ steps.setup_project.outputs.project_id }}
          
          echo "ğŸ” Checking if MongoDB exists..."
          PROJECT_DATA=$(curl -s -H "x-api-key: ${{ secrets.DOKPLOY_API_KEY }}" "$DOKPLOY_URL/project.one?projectId=$PROJECT_ID")
          
          echo "Project Data: $PROJECT_DATA"
          
          # Dokploy agrega sufijos aleatorios, buscar por nombre que contenga el prefijo
          MONGO_ID=$(echo "$PROJECT_DATA" | jq -r ".environments[] | select(.environmentId==\"$ENV_ID\") | .mongo[]? | select(.name==\"MongoDB Database\") | .mongoId" | head -n 1)
          
          if [ -z "$MONGO_ID" ]; then
            echo "ğŸ§© Creating MongoDB service..."
            CREATE_MONGO=$(curl -s -X POST "$DOKPLOY_URL/mongo.create" \
              -H "x-api-key: ${{ secrets.DOKPLOY_API_KEY }}" \
              -H "Content-Type: application/json" \
              -d "{
                \"name\": \"MongoDB Database\",
                \"appName\": \"${{ env.MONGO_APP_NAME }}\",
                \"dockerImage\": \"mongo:7.0-jammy\",
                \"environmentId\": \"$ENV_ID\",
                \"description\": \"MongoDB for Red Social Gera\",
                \"databaseUser\": \"admin\",
                \"databasePassword\": \"${{ secrets.MONGO_PASSWORD }}\",
                \"databaseName\": \"social_network_prod\"
              }")
            
            echo "Create Mongo Response: $CREATE_MONGO"
            
            # La API devuelve solo 'true', necesitamos obtener el ID consultando de nuevo
            if [ "$CREATE_MONGO" = "true" ]; then
              echo "âœ… MongoDB created successfully"
              
              # Esperar un momento para que se cree
              sleep 3
              
              # Obtener el ID del MongoDB reciÃ©n creado (buscar por nombre)
              echo "ğŸ” Getting MongoDB ID..."
              PROJECT_DATA_UPDATED=$(curl -s -H "x-api-key: ${{ secrets.DOKPLOY_API_KEY }}" "$DOKPLOY_URL/project.one?projectId=$PROJECT_ID")
              MONGO_ID=$(echo "$PROJECT_DATA_UPDATED" | jq -r ".environments[] | select(.environmentId==\"$ENV_ID\") | .mongo[]? | select(.name==\"MongoDB Database\") | .mongoId" | head -n 1)
              MONGO_APP_NAME_ACTUAL=$(echo "$PROJECT_DATA_UPDATED" | jq -r ".environments[] | select(.environmentId==\"$ENV_ID\") | .mongo[]? | select(.mongoId==\"$MONGO_ID\") | .appName")
              
              if [ -z "$MONGO_ID" ]; then
                echo "âŒ Error: Could not retrieve MongoDB ID after creation"
                exit 1
              fi
              
              echo "âœ… MongoDB ID: $MONGO_ID"
              echo "âœ… MongoDB App Name: $MONGO_APP_NAME_ACTUAL"
              
              # Guardar el nombre real para usarlo en la URI de conexiÃ³n
              echo "mongo_app_name=$MONGO_APP_NAME_ACTUAL" >> $GITHUB_OUTPUT
              
              # Esperar un poco mÃ¡s antes de deployar
              sleep 2
              
              # Deploy MongoDB
              echo "ğŸš€ Deploying MongoDB..."
              DEPLOY_MONGO=$(curl -s -X POST "$DOKPLOY_URL/mongo.deploy" \
                -H "x-api-key: ${{ secrets.DOKPLOY_API_KEY }}" \
                -H "Content-Type: application/json" \
                -d "{\"mongoId\": \"$MONGO_ID\"}")
              
              echo "Deploy Mongo Response: $DEPLOY_MONGO"
            else
              echo "âŒ Error creating MongoDB. Response: $CREATE_MONGO"
              exit 1
            fi
          else
            echo "âœ… MongoDB already exists: $MONGO_ID"
            # Obtener el appName real del MongoDB existente
            MONGO_APP_NAME_ACTUAL=$(echo "$PROJECT_DATA" | jq -r ".environments[] | select(.environmentId==\"$ENV_ID\") | .mongo[]? | select(.mongoId==\"$MONGO_ID\") | .appName")
            echo "âœ… MongoDB App Name: $MONGO_APP_NAME_ACTUAL"
            echo "mongo_app_name=$MONGO_APP_NAME_ACTUAL" >> $GITHUB_OUTPUT
          fi
          
          echo "mongo_id=$MONGO_ID" >> $GITHUB_OUTPUT

      # 7ï¸âƒ£ Setup or Update Backend Application
      - name: ğŸš€ Setup Backend Application
        id: setup_backend
        run: |
          ENV_ID=${{ steps.setup_project.outputs.env_id }}
          PROJECT_ID=${{ steps.setup_project.outputs.project_id }}
          MONGO_APP_NAME_ACTUAL=${{ steps.setup_mongo.outputs.mongo_app_name }}
          
          echo "ğŸ” Checking if Backend exists..."
          PROJECT_DATA=$(curl -s -H "x-api-key: ${{ secrets.DOKPLOY_API_KEY }}" "$DOKPLOY_URL/project.one?projectId=$PROJECT_ID")
          
          echo "Project Data: $PROJECT_DATA"
          
          # Buscar por nombre de la aplicaciÃ³n (Backend API)
          APP_ID=$(echo "$PROJECT_DATA" | jq -r ".environments[] | select(.environmentId==\"$ENV_ID\") | .applications[]? | select(.name==\"Backend API\") | .applicationId" | head -n 1)
          
          if [ -z "$APP_ID" ]; then
            echo "ğŸ§© Creating Backend application..."
            CREATE_APP=$(curl -s -X POST "$DOKPLOY_URL/application.create" \
              -H "x-api-key: ${{ secrets.DOKPLOY_API_KEY }}" \
              -H "Content-Type: application/json" \
              -d "{
                \"name\": \"Backend API\",
                \"appName\": \"${{ env.APP_NAME }}\",
                \"environmentId\": \"$ENV_ID\",
                \"description\": \"NestJS Backend API\"
              }")
            
            echo "Create App Response: $CREATE_APP"
            
            # La API devuelve solo 'true', necesitamos obtener el ID consultando de nuevo
            if [ "$CREATE_APP" = "true" ]; then
              echo "âœ… Backend created successfully"
              
              # Esperar un momento para que se cree
              sleep 3
              
              # Obtener el ID de la aplicaciÃ³n reciÃ©n creada
              echo "ğŸ” Getting Backend Application ID..."
              PROJECT_DATA_UPDATED=$(curl -s -H "x-api-key: ${{ secrets.DOKPLOY_API_KEY }}" "$DOKPLOY_URL/project.one?projectId=$PROJECT_ID")
              APP_ID=$(echo "$PROJECT_DATA_UPDATED" | jq -r ".environments[] | select(.environmentId==\"$ENV_ID\") | .applications[]? | select(.name==\"Backend API\") | .applicationId" | head -n 1)
              
              if [ -z "$APP_ID" ]; then
                echo "âŒ Error: Could not retrieve Application ID after creation"
                exit 1
              fi
              
              echo "âœ… Backend Application ID: $APP_ID"
              
              # Configurar Docker provider
              echo "ğŸ³ Configuring Docker provider..."
              DOCKER_CONFIG=$(curl -s -X POST "$DOKPLOY_URL/application.saveDockerProvider" \
                -H "x-api-key: ${{ secrets.DOKPLOY_API_KEY }}" \
                -H "Content-Type: application/json" \
                -d "{
                  \"applicationId\": \"$APP_ID\",
                  \"dockerImage\": \"${{ secrets.DOCKHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest\",
                  \"username\": \"${{ secrets.DOCKHUB_USERNAME }}\",
                  \"password\": \"${{ secrets.DOCKHUB_PASSWORD }}\"
                }")
              
              echo "Docker Config Response: $DOCKER_CONFIG"
              
              # Configurar variables de entorno especÃ­ficas del backend usando el appName real
              echo "ğŸ”§ Configuring backend environment..."
              BACKEND_ENV="MONGODB_URI=mongodb://${MONGO_APP_NAME_ACTUAL}:27017/social_network_prod"
              
              ENV_CONFIG=$(curl -s -X POST "$DOKPLOY_URL/application.saveEnvironment" \
                -H "x-api-key: ${{ secrets.DOKPLOY_API_KEY }}" \
                -H "Content-Type: application/json" \
                -d "{
                  \"applicationId\": \"$APP_ID\",
                  \"env\": $(echo "$BACKEND_ENV" | jq -Rs .)
                }")
              
              echo "Environment Config Response: $ENV_CONFIG"
              
              # Actualizar configuraciÃ³n de la aplicaciÃ³n
              echo "âš™ï¸ Updating application settings..."
              APP_UPDATE=$(curl -s -X POST "$DOKPLOY_URL/application.update" \
                -H "x-api-key: ${{ secrets.DOKPLOY_API_KEY }}" \
                -H "Content-Type: application/json" \
                -d "{
                  \"applicationId\": \"$APP_ID\",
                  \"sourceType\": \"docker\",
                  \"memoryLimit\": 512,
                  \"memoryReservation\": 256,
                  \"cpuLimit\": 1,
                  \"cpuReservation\": 0.5
                }")
              
              echo "App Update Response: $APP_UPDATE"
            else
              echo "âŒ Error creating Backend. Response: $CREATE_APP"
              exit 1
            fi
          else
            echo "âœ… Backend already exists: $APP_ID"
            
            # Actualizar imagen de Docker
            echo "ğŸ”„ Updating Docker image..."
            DOCKER_UPDATE=$(curl -s -X POST "$DOKPLOY_URL/application.saveDockerProvider" \
              -H "x-api-key: ${{ secrets.DOKPLOY_API_KEY }}" \
              -H "Content-Type: application/json" \
              -d "{
                \"applicationId\": \"$APP_ID\",
                \"dockerImage\": \"${{ secrets.DOCKHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest\",
                \"username\": \"${{ secrets.DOCKHUB_USERNAME }}\",
                \"password\": \"${{ secrets.DOCKHUB_PASSWORD }}\"
              }")
            
            echo "Docker Update Response: $DOCKER_UPDATE"
            
            # Actualizar MONGODB_URI con el nombre real
            echo "ğŸ”§ Updating backend environment with real MongoDB URI..."
            BACKEND_ENV="MONGODB_URI=mongodb://${MONGO_APP_NAME_ACTUAL}:27017/social_network_prod"
            
            ENV_UPDATE=$(curl -s -X POST "$DOKPLOY_URL/application.saveEnvironment" \
              -H "x-api-key: ${{ secrets.DOKPLOY_API_KEY }}" \
              -H "Content-Type: application/json" \
              -d "{
                \"applicationId\": \"$APP_ID\",
                \"env\": $(echo "$BACKEND_ENV" | jq -Rs .)
              }")
            
            echo "Environment Update Response: $ENV_UPDATE"
          fi
          
          echo "app_id=$APP_ID" >> $GITHUB_OUTPUT

      # 8ï¸âƒ£ Deploy Backend
      - name: ğŸ¯ Deploy Backend Application
        run: |
          APP_ID=${{ steps.setup_backend.outputs.app_id }}
          
          echo "ğŸš€ Deploying backend application..."
          DEPLOY_RESPONSE=$(curl -s -X POST "$DOKPLOY_URL/application.deploy" \
            -H "x-api-key: ${{ secrets.DOKPLOY_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"applicationId\": \"$APP_ID\",
              \"title\": \"Deploy from GitHub Actions\",
              \"description\": \"Automatic deployment - Commit: ${{ github.sha }}\"
            }")
          
          echo "Deploy response: $DEPLOY_RESPONSE"
          echo "âœ… Backend deployment triggered successfully!"
          echo "ğŸ“ Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Author: ${{ github.actor }}"

      # 9ï¸âƒ£ Summary
      - name: ğŸ“Š Deployment Summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ‰ Deployment Summary"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¦ Project: ${{ env.PROJECT_NAME }}"
          echo "ğŸŒ Environment: ${{ env.ENVIRONMENT_NAME }}"
          echo "ğŸƒ MongoDB: ${{ steps.setup_mongo.outputs.mongo_id }}"
          echo "ğŸš€ Backend: ${{ steps.setup_backend.outputs.app_id }}"
          echo "ğŸ³ Image: ${{ secrets.DOCKHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest"
          echo "ğŸ“ Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Author: ${{ github.actor }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
