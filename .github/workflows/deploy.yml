name: üöÄ Deploy to Production (Dokploy)

on:
  push:
    branches:
      - master

env:
  IMAGE_NAME: backend_red_social_gera
  PROJECT_NAME: redsocialgera
  ENVIRONMENT_NAME: production
  APP_NAME: redsocialgera-backend
  MONGO_APP_NAME: redsocialgera-mongodb
  DOKPLOY_URL: ${{ secrets.DOKPLOY_URL }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Docker Setup
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKHUB_USERNAME }}
          password: ${{ secrets.DOCKHUB_PASSWORD }}

      # 3Ô∏è‚É£ Build and push image
      - name: Build and Push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest
            ${{ secrets.DOCKHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          platforms: linux/amd64,linux/arm64
          cache-from: type=registry,ref=${{ secrets.DOCKHUB_USERNAME }}/${{ env.IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ secrets.DOCKHUB_USERNAME }}/${{ env.IMAGE_NAME }}:buildcache,mode=max

      # 4Ô∏è‚É£ Create Project (if not exists)
      - name: Create Project in Dokploy
        id: create_project
        run: |
          echo "üîç Checking if project exists..."
          PROJECT_RESPONSE=$(curl -s -H "x-api-key: ${{ secrets.DOKPLOY_API_KEY }}" "$DOKPLOY_URL/project.all")
          echo "Project response:"
          PROJECT_ID=$(echo "$PROJECT_RESPONSE" | jq -r "map(select(.name==\"${{ env.PROJECT_NAME }}\"))[0].id")
          
          if [ "$PROJECT_ID" == "null" ] || [ -z "$PROJECT_ID" ]; then
            echo "üß© Creating project ${{ env.PROJECT_NAME }}..."
            CREATE_RESPONSE=$(curl -s -X POST "$DOKPLOY_URL/project.create" \
              -H "x-api-key: ${{ secrets.DOKPLOY_API_KEY }}" \
              -H "Content-Type: application/json" \
              -d "{\"name\": \"${{ env.PROJECT_NAME }}\", \"description\": \"Proyecto CI/CD autom√°tico\", \"env\": \"production\"}")
            PROJECT_ID=$(echo "$CREATE_RESPONSE" | jq -r ".id")
          fi

          echo "‚úÖ Project ID: $PROJECT_ID"
          echo "project_id=$PROJECT_ID" >> $GITHUB_OUTPUT

      # 5Ô∏è‚É£ Create Environment (if not exists)
      - name: Create Environment in Dokploy
        id: create_environment
        run: |
          PROJECT_ID=${{ steps.create_project.outputs.project_id }}
          echo "üîç Checking if environment exists..."
          ENV_RESPONSE=$(curl -s -H "x-api-key: ${{ secrets.DOKPLOY_API_KEY }}" "$DOKPLOY_URL/environment.byProjectId?projectId=$PROJECT_ID")
          ENV_ID=$(echo "$ENV_RESPONSE" | jq -r ".result.data | map(select(.name==\"${{ env.ENVIRONMENT_NAME }}\"))[0].id")

          if [ "$ENV_ID" == "null" ] || [ -z "$ENV_ID" ]; then
            echo "üß© Creating environment ${{ env.ENVIRONMENT_NAME }}..."
            CREATE_ENV=$(curl -s -X POST "$DOKPLOY_URL/environment.create" \
              -H "x-api-key: ${{ secrets.DOKPLOY_API_KEY }}" \
              -H "Content-Type: application/json" \
              -d "{\"name\": \"${{ env.ENVIRONMENT_NAME }}\", \"description\": \"Entorno de producci√≥n\", \"projectId\": \"$PROJECT_ID\"}")
            ENV_ID=$(echo "$CREATE_ENV" | jq -r ".id")
          fi

          echo "‚úÖ Environment ID: $ENV_ID"
          echo "env_id=$ENV_ID" >> $GITHUB_OUTPUT

      # 6Ô∏è‚É£ Create Mongo service (if not exists)
      - name: Create MongoDB in Dokploy
        id: create_mongo
        run: |
          ENV_ID=${{ steps.create_environment.outputs.env_id }}
          echo "üîç Checking if MongoDB exists..."
          MONGO_RESPONSE=$(curl -s -H "x-api-key: ${{ secrets.DOKPLOY_API_KEY }}" "$DOKPLOY_URL/mongo.one?appName=${{ env.MONGO_APP_NAME }}")
          MONGO_ID=$(echo "$MONGO_RESPONSE" | jq -r ".id")

          if [ "$MONGO_ID" == "null" ] || [ -z "$MONGO_ID" ]; then
            echo "üß© Creating MongoDB service..."
            CREATE_MONGO=$(curl -s -X POST "$DOKPLOY_URL/mongo.create" \
              -H "x-api-key: ${{ secrets.DOKPLOY_API_KEY }}" \
              -H "Content-Type: application/json" \
              -d "{
                \"name\": \"${{ env.MONGO_APP_NAME }}\",
                \"appName\": \"${{ env.MONGO_APP_NAME }}\",
                \"dockerImage\": \"mongo:7.0-jammy\",
                \"environmentId\": \"$ENV_ID\",
                \"databaseUser\": \"admin\",
                \"databasePassword\": \"change_me_in_dokploy\",
                \"description\": \"MongoDB for backend\"
              }")
            MONGO_ID=$(echo "$CREATE_MONGO" | jq -r ".id")
          fi

          echo "‚úÖ MongoDB ID: $MONGO_ID"
          echo "mongo_id=$MONGO_ID" >> $GITHUB_OUTPUT

      # 7Ô∏è‚É£ Create Backend application (if not exists)
      - name: Create Backend in Dokploy
        id: create_backend
        run: |
          ENV_ID=${{ steps.create_environment.outputs.env_id }}
          echo "üîç Checking if backend exists..."
          APP_RESPONSE=$(curl -s -H "x-api-key: ${{ secrets.DOKPLOY_API_KEY }}" "$DOKPLOY_URL/application.one?appName=${{ env.APP_NAME }}")
          APP_ID=$(echo "$APP_RESPONSE" | jq -r ".id")

          if [ "$APP_ID" == "null" ] || [ -z "$APP_ID" ]; then
            echo "üß© Creating backend service..."
            CREATE_APP=$(curl -s -X POST "$DOKPLOY_URL/application.create" \
              -H "x-api-key: ${{ secrets.DOKPLOY_API_KEY }}" \
              -H "Content-Type: application/json" \
              -d "{
                \"name\": \"${{ env.APP_NAME }}\",
                \"appName\": \"${{ env.APP_NAME }}\",
                \"environmentId\": \"$ENV_ID\",
                \"description\": \"Backend NestJS API\",
                \"serverId\": null
              }")
            APP_ID=$(echo "$CREATE_APP" | jq -r ".id")
          fi

          echo "‚úÖ Backend ID: $APP_ID"
          echo "app_id=$APP_ID" >> $GITHUB_OUTPUT

      # 8Ô∏è‚É£ Deploy Backend
      - name: Trigger Dokploy Deployment
        run: |
          APP_ID=${{ steps.create_backend.outputs.app_id }}
          echo "üöÄ Deploying backend in Dokploy..."
          curl -s -X POST "$DOKPLOY_URL/application.deploy" \
            -H "x-api-key: ${{ secrets.DOKPLOY_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{\"applicationId\": \"$APP_ID\", \"title\": \"Automatic Deploy\", \"description\": \"CI/CD auto deploy\"}"
          echo "‚úÖ Deployment triggered successfully"
